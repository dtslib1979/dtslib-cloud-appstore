<!DOCTYPE html>
<html lang="ko" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>🎓 Lecture Shorts Factory v6.5 Pro</title>
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="./icons/icon-192x192.png">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="description" content="4분 강의 영상을 3분 유튜브 쇼츠로 자동 변환 - Pro Edition">
    <link rel="stylesheet" href="./style.css">

    <!-- Preload FFmpeg -->
    <link rel="preload" href="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js" as="script">
</head>
<body>
    <!-- Update Notification -->
    <div id="updateBanner" class="update-banner" style="display:none;">
        <span>🔄 새 버전이 있습니다!</span>
        <button onclick="location.reload(true)">업데이트</button>
        <button onclick="dismissUpdate()" class="dismiss">✕</button>
    </div>

    <div class="container">
        <header>
            <div class="header-row">
                <h1>🎓 Lecture Shorts Factory</h1>
                <button class="theme-toggle" onclick="toggleTheme()" title="테마 변경 (T)" aria-label="테마 변경">
                    <span id="themeIcon">🌙</span>
                </button>
            </div>
            <p class="subtitle">강의 영상 → 유튜브 쇼츠 자동 변환</p>
            <div class="version-row">
                <span class="version">v6.5 Pro</span>
                <span id="engineInfo" class="engine-badge">검사 중...</span>
            </div>
        </header>

        <!-- Settings Panel -->
        <section class="settings-panel" id="settingsPanel">
            <div class="settings-header" onclick="toggleSettings()" role="button" tabindex="0" aria-expanded="false">
                <span>⚙️ 고급 설정</span>
                <span id="settingsArrow" class="arrow">▼</span>
            </div>
            <div class="settings-content" id="settingsContent" style="display:none;">
                <!-- Quality Preset -->
                <div class="setting-group">
                    <label>📊 품질 프리셋</label>
                    <div class="quality-buttons">
                        <button id="qualityLow" class="quality-btn" onclick="setQuality('low')">
                            <span class="quality-icon">⚡</span>
                            <span class="quality-name">빠름</span>
                            <span class="quality-desc">작은 파일</span>
                        </button>
                        <button id="qualityMid" class="quality-btn active" onclick="setQuality('medium')">
                            <span class="quality-icon">⚖️</span>
                            <span class="quality-name">균형</span>
                            <span class="quality-desc">추천</span>
                        </button>
                        <button id="qualityHigh" class="quality-btn" onclick="setQuality('high')">
                            <span class="quality-icon">💎</span>
                            <span class="quality-name">고품질</span>
                            <span class="quality-desc">큰 파일</span>
                        </button>
                    </div>
                </div>

                <!-- Resolution -->
                <div class="setting-group">
                    <label for="resolutionSelect">📐 해상도</label>
                    <select id="resolutionSelect" onchange="updateResolution()">
                        <option value="480">480p (빠른 처리)</option>
                        <option value="720" selected>720p (추천)</option>
                        <option value="1080">1080p (고화질)</option>
                    </select>
                </div>

                <!-- Target Duration -->
                <div class="setting-group">
                    <label>⏱️ 목표 길이</label>
                    <div class="duration-input">
                        <input type="number" id="targetMin" value="3" min="1" max="10" onchange="updateDuration()" aria-label="분">
                        <span>분</span>
                        <input type="number" id="targetSec" value="0" min="0" max="59" onchange="updateDuration()" aria-label="초">
                        <span>초</span>
                    </div>
                    <small class="hint">유튜브 쇼츠 최대 3분</small>
                </div>

                <!-- FPS -->
                <div class="setting-group">
                    <label for="fpsSelect">🎬 프레임레이트</label>
                    <select id="fpsSelect" onchange="updateFps()">
                        <option value="24">24fps (영화)</option>
                        <option value="30" selected>30fps (표준)</option>
                        <option value="60">60fps (부드러움)</option>
                    </select>
                </div>

                <!-- Settings Actions -->
                <div class="settings-actions">
                    <button onclick="saveSettings()" class="btn-action btn-save" title="현재 설정 저장">
                        💾 저장
                    </button>
                    <button onclick="loadSettings()" class="btn-action btn-load" title="저장된 설정 불러오기">
                        📂 불러오기
                    </button>
                    <button onclick="resetSettings()" class="btn-action btn-reset" title="기본값으로 초기화">
                        🔄 초기화
                    </button>
                </div>
            </div>
        </section>

        <!-- Warnings -->
        <div id="memWarn" class="warn-box" style="display:none;">
            ⚠️ 메모리 4GB 미만 - 긴 영상은 처리 실패 가능
        </div>
        <div id="fileSizeWarn" class="warn-box" style="display:none;"></div>

        <!-- Background Tip -->
        <div class="tip-box">
            💡 <strong>팁:</strong> 인코딩 중 화면을 켜두세요. 백그라운드 전환 시 느려질 수 있습니다.
        </div>

        <main>
            <!-- Step 1: Main Video -->
            <section class="step-card">
                <div class="step-header">
                    <span class="step-num">1</span>
                    <span class="step-title">강의 영상 선택</span>
                </div>
                <div class="file-drop-zone" id="vidDropZone"
                     onclick="el('vidIn').click()"
                     ondragover="handleDragOver(event)"
                     ondrop="handleDrop(event, 'vid')"
                     role="button" tabindex="0" aria-label="강의 영상 선택">
                    <input type="file" id="vidIn" accept="video/*" hidden>
                    <div class="drop-content">
                        <span class="drop-icon">🎬</span>
                        <span class="drop-text">클릭 또는 드래그</span>
                        <span class="drop-hint">MP4, MOV, WebM (최대 500MB)</span>
                    </div>
                </div>
                <div id="vidInfo" class="file-info"></div>
            </section>

            <!-- Step 2: Intro Video -->
            <section class="step-card">
                <div class="step-header">
                    <span class="step-num">2</span>
                    <span class="step-title">인트로 영상 선택</span>
                </div>
                <div class="file-drop-zone" id="introDropZone"
                     onclick="el('introIn').click()"
                     ondragover="handleDragOver(event)"
                     ondrop="handleDrop(event, 'intro')"
                     role="button" tabindex="0" aria-label="인트로 영상 선택">
                    <input type="file" id="introIn" accept="video/*" hidden>
                    <div class="drop-content">
                        <span class="drop-icon">🎪</span>
                        <span class="drop-text">클릭 또는 드래그</span>
                        <span class="drop-hint">권장: 15~30초</span>
                    </div>
                </div>
                <div id="introInfo" class="file-info"></div>
            </section>

            <!-- Step 3: BGM (Optional) -->
            <section class="step-card">
                <div class="step-header">
                    <span class="step-num">3</span>
                    <span class="step-title">🎵 배경음악 <span class="optional">(선택)</span></span>
                </div>
                <div class="file-drop-zone secondary" id="bgmDropZone"
                     onclick="el('bgmIn').click()"
                     ondragover="handleDragOver(event)"
                     ondrop="handleDrop(event, 'bgm')"
                     role="button" tabindex="0" aria-label="배경음악 선택">
                    <input type="file" id="bgmIn" accept="audio/*" hidden>
                    <div class="drop-content">
                        <span class="drop-icon">🎵</span>
                        <span class="drop-text">클릭 또는 드래그</span>
                        <span class="drop-hint">MP3, WAV, M4A</span>
                    </div>
                </div>
                <div id="bgmInfo" class="file-info"></div>

                <!-- BGM Volume Control -->
                <div id="bgmVolControl" class="volume-control" style="display:none;">
                    <div class="volume-header">
                        <span>🔊 BGM 볼륨</span>
                        <span id="bgmVolValue" class="volume-value">10%</span>
                    </div>
                    <input type="range" id="bgmVolSlider" min="0" max="50" value="10"
                           class="volume-slider" aria-label="BGM 볼륨">
                    <div class="volume-labels">
                        <span>0%</span>
                        <span>25%</span>
                        <span>50%</span>
                    </div>
                    <button class="preview-btn" id="bgmPreviewBtn" onclick="previewBgm()">
                        ▶️ 미리듣기 (5초)
                    </button>
                </div>
            </section>

            <!-- Step 4: Device Preset -->
            <section class="step-card">
                <div class="step-header">
                    <span class="step-num">4</span>
                    <span class="step-title">📱 촬영 기기</span>
                </div>
                <p class="step-desc">UI 바 자동 제거를 위한 크롭 설정</p>
                <div class="device-buttons">
                    <button id="btnTabS9" class="device-btn" onclick="setPreset('TAB_S9')">
                        <span class="device-icon">📱</span>
                        <span class="device-name">Tab S9</span>
                    </button>
                    <button id="btnS25" class="device-btn" onclick="setPreset('S25_ULTRA')">
                        <span class="device-icon">📱</span>
                        <span class="device-name">S25 Ultra</span>
                    </button>
                    <button id="btnNone" class="device-btn active" onclick="setPreset(null)">
                        <span class="device-icon">📷</span>
                        <span class="device-name">기본</span>
                    </button>
                </div>
                <div id="presetInfo" class="preset-info">크롭 없음</div>
            </section>

            <!-- Step 5: Transition Effects -->
            <section class="step-card">
                <div class="step-header">
                    <span class="step-num">5</span>
                    <span class="step-title">✨ 트랜지션 효과 <span class="optional">(선택)</span></span>
                </div>
                <p class="step-desc">인트로→본편 연결 및 엔딩에 적용</p>

                <div class="effect-section">
                    <label class="effect-label">🔗 인트로→본편 트랜지션</label>
                    <div class="effect-buttons" id="transitionEffects">
                        <button class="effect-btn active" onclick="setTransition('none')" data-effect="none">
                            <span class="effect-icon">⊘</span>
                            <span class="effect-name">없음</span>
                        </button>
                        <button class="effect-btn" onclick="setTransition('tv')" data-effect="tv">
                            <span class="effect-icon">📺</span>
                            <span class="effect-name">TV</span>
                        </button>
                        <button class="effect-btn" onclick="setTransition('vhs')" data-effect="vhs">
                            <span class="effect-icon">📼</span>
                            <span class="effect-name">VHS</span>
                        </button>
                        <button class="effect-btn" onclick="setTransition('focus')" data-effect="focus">
                            <span class="effect-icon">🎯</span>
                            <span class="effect-name">FOCUS</span>
                        </button>
                        <button class="effect-btn" onclick="setTransition('tremble')" data-effect="tremble">
                            <span class="effect-icon">📳</span>
                            <span class="effect-name">TREMBLE</span>
                        </button>
                        <button class="effect-btn" onclick="setTransition('zoom')" data-effect="zoom">
                            <span class="effect-icon">🔍</span>
                            <span class="effect-name">ZOOM</span>
                        </button>
                    </div>
                </div>

                <div class="effect-section">
                    <label class="effect-label">🎬 엔딩 효과</label>
                    <div class="effect-buttons" id="endingEffects">
                        <button class="effect-btn active" onclick="setEnding('none')" data-effect="none">
                            <span class="effect-icon">⊘</span>
                            <span class="effect-name">없음</span>
                        </button>
                        <button class="effect-btn" onclick="setEnding('tv')" data-effect="tv">
                            <span class="effect-icon">📺</span>
                            <span class="effect-name">TV</span>
                        </button>
                        <button class="effect-btn" onclick="setEnding('vhs')" data-effect="vhs">
                            <span class="effect-icon">📼</span>
                            <span class="effect-name">VHS</span>
                        </button>
                        <button class="effect-btn" onclick="setEnding('focus')" data-effect="focus">
                            <span class="effect-icon">🎯</span>
                            <span class="effect-name">FOCUS</span>
                        </button>
                        <button class="effect-btn" onclick="setEnding('tremble')" data-effect="tremble">
                            <span class="effect-icon">📳</span>
                            <span class="effect-name">TREMBLE</span>
                        </button>
                        <button class="effect-btn" onclick="setEnding('zoom')" data-effect="zoom">
                            <span class="effect-icon">🔍</span>
                            <span class="effect-name">ZOOM</span>
                        </button>
                    </div>
                </div>

                <div class="effect-duration">
                    <label>⏱️ 효과 길이</label>
                    <select id="effectDuration" onchange="updateEffectDuration()">
                        <option value="0.5">0.5초 (빠름)</option>
                        <option value="1" selected>1초 (기본)</option>
                        <option value="1.5">1.5초 (느림)</option>
                        <option value="2">2초 (매우 느림)</option>
                    </select>
                </div>
            </section>

            <!-- Step 6: Generate -->
            <section class="step-card generate-card" id="step5">
                <div class="step-header">
                    <span class="step-num">6</span>
                    <span class="step-title">🚀 변환</span>
                </div>

                <!-- Summary -->
                <div id="summary" class="summary-box" style="display:none;">
                    <div class="summary-title">📋 변환 요약</div>
                    <div id="summaryContent"></div>
                </div>

                <button id="genBtn" class="generate-btn" onclick="generate()" disabled>
                    <span class="btn-icon">🎬</span>
                    <span class="btn-text">쇼츠 생성하기</span>
                </button>

                <div class="keyboard-hint">
                    <kbd>Enter</kbd> 생성 · <kbd>R</kbd> 리셋 · <kbd>T</kbd> 테마 · <kbd>?</kbd> 도움말
                </div>
            </section>

            <!-- Progress -->
            <section id="progress" class="progress-section" style="display:none;">
                <div class="progress-header">
                    <span id="status" class="status">준비 중...</span>
                    <button onclick="abortProcessing()" class="abort-btn" title="중단 (Esc)">⏹️ 중단</button>
                </div>

                <div class="progress-bar-container">
                    <div class="progress-bar">
                        <div id="progFill" class="progress-fill"></div>
                    </div>
                    <div class="progress-details">
                        <span id="progText">0%</span>
                        <span id="etaText" class="eta"></span>
                    </div>
                </div>

                <div id="progressLog" class="progress-log"></div>
            </section>

            <!-- Result -->
            <section id="result" class="result-section" style="display:none;">
                <div class="result-header">
                    <span class="result-icon">✅</span>
                    <span class="result-title">변환 완료!</span>
                </div>

                <div id="resultStats" class="result-stats"></div>

                <video id="preview" controls playsinline class="preview-video"></video>

                <div class="result-actions">
                    <a id="dlLink" class="action-btn download-btn" download>
                        💾 다운로드
                    </a>
                    <button onclick="shareResult()" class="action-btn share-btn">
                        📤 공유
                    </button>
                    <button onclick="reset()" class="action-btn reset-btn">
                        🔄 새로 만들기
                    </button>
                </div>
            </section>
        </main>

        <footer>
            <p class="footer-brand">Lecture Shorts Factory v6.5 Pro</p>
            <p class="footer-links">
                <button onclick="showHelp()" class="footer-link">📖 도움말</button>
                <span class="separator">·</span>
                <button onclick="showKeyboardShortcuts()" class="footer-link">⌨️ 단축키</button>
                <span class="separator">·</span>
                <button onclick="showAbout()" class="footer-link">ℹ️ 정보</button>
            </p>
        </footer>
    </div>

    <!-- Modals -->
    <!-- Help Modal -->
    <div id="helpModal" class="modal" style="display:none;" role="dialog" aria-modal="true">
        <div class="modal-backdrop" onclick="closeModal('helpModal')"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>📖 사용 가이드</h3>
                <button onclick="closeModal('helpModal')" class="modal-close" aria-label="닫기">✕</button>
            </div>
            <div class="modal-body">
                <h4>기본 사용법</h4>
                <ol>
                    <li>강의 영상 선택 (4분 이상 권장)</li>
                    <li>인트로 영상 선택 (15~30초 권장)</li>
                    <li>필요시 BGM 추가 및 볼륨 조절</li>
                    <li>촬영 기기 선택 (자동 크롭)</li>
                    <li>변환 시작!</li>
                </ol>

                <h4>고급 설정</h4>
                <ul>
                    <li><strong>품질 프리셋</strong>: 빠름/균형/고품질 선택</li>
                    <li><strong>해상도</strong>: 480p ~ 1080p</li>
                    <li><strong>목표 길이</strong>: 최종 영상 길이 (기본 3분)</li>
                    <li><strong>FPS</strong>: 24/30/60fps</li>
                </ul>

                <h4>💡 팁</h4>
                <ul>
                    <li>Chrome/Edge에서 WebCodecs 하드웨어 가속 지원</li>
                    <li>설정 저장으로 다음에 빠르게 시작</li>
                    <li>처리 중 화면을 켜두세요</li>
                    <li>파일 크기 500MB 이하 권장</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div id="shortcutsModal" class="modal" style="display:none;" role="dialog" aria-modal="true">
        <div class="modal-backdrop" onclick="closeModal('shortcutsModal')"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>⌨️ 키보드 단축키</h3>
                <button onclick="closeModal('shortcutsModal')" class="modal-close" aria-label="닫기">✕</button>
            </div>
            <div class="modal-body shortcuts-list">
                <div class="shortcut"><kbd>Enter</kbd><span>변환 시작</span></div>
                <div class="shortcut"><kbd>R</kbd><span>리셋</span></div>
                <div class="shortcut"><kbd>T</kbd><span>테마 변경</span></div>
                <div class="shortcut"><kbd>S</kbd><span>설정 토글</span></div>
                <div class="shortcut"><kbd>1</kbd><span>강의 영상 선택</span></div>
                <div class="shortcut"><kbd>2</kbd><span>인트로 영상 선택</span></div>
                <div class="shortcut"><kbd>3</kbd><span>BGM 선택</span></div>
                <div class="shortcut"><kbd>?</kbd><span>도움말</span></div>
                <div class="shortcut"><kbd>Esc</kbd><span>모달 닫기 / 중단</span></div>
            </div>
        </div>
    </div>

    <!-- About Modal -->
    <div id="aboutModal" class="modal" style="display:none;" role="dialog" aria-modal="true">
        <div class="modal-backdrop" onclick="closeModal('aboutModal')"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>ℹ️ 정보</h3>
                <button onclick="closeModal('aboutModal')" class="modal-close" aria-label="닫기">✕</button>
            </div>
            <div class="modal-body">
                <div class="about-logo">🎓</div>
                <h4>Lecture Shorts Factory</h4>
                <p class="about-version">v6.5 Pro Edition</p>
                <p class="about-desc">강의 영상을 유튜브 쇼츠 형식으로 자동 변환하는 PWA</p>

                <h4>기술 스택</h4>
                <div class="tech-stack">
                    <span class="tech-badge">🚀 WebCodecs</span>
                    <span class="tech-badge">🎵 FFmpeg.wasm</span>
                    <span class="tech-badge">📱 PWA</span>
                    <span class="tech-badge">🔒 Wake Lock</span>
                </div>

                <h4>브라우저 호환</h4>
                <ul class="browser-list">
                    <li>✅ Chrome 94+ (권장)</li>
                    <li>✅ Edge 94+</li>
                    <li>⚠️ Safari (FFmpeg 폴백)</li>
                    <li>⚠️ Firefox (FFmpeg 폴백)</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- FFmpeg Script (defer) -->
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js" defer></script>
    <script src="./app.js"></script>
</body>
</html>
